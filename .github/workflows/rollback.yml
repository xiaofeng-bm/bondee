name: Rollback to Previous Version

on:
  workflow_dispatch:
    inputs:
      version:
        description: "è¦å›æ»šåˆ°çš„ç‰ˆæœ¬æ ‡ç­¾ï¼ˆç•™ç©ºåˆ™å›æ»šåˆ° previous ç‰ˆæœ¬ï¼‰"
        required: false
        default: "previous"
        type: string

env:
  DOCKER_IMAGE_NAME: bondee
  DEPLOY_PATH: /opt/bondee

jobs:
  rollback:
    runs-on: ubuntu-latest

    steps:
      - name: Display rollback info
        run: |
          echo "ğŸ”„ å‡†å¤‡å›æ»šåˆ°ç‰ˆæœ¬: ${{ inputs.version }}"
          echo "ç›®æ ‡æœåŠ¡å™¨: ${{ secrets.ALIYUN_SERVER_HOST }}"

      - name: Execute rollback on server
        uses: appleboy/ssh-action@v1.0.0
        env:
          ROLLBACK_TAG: ${{ inputs.version }}
          DOCKER_REGISTRY: ${{ secrets.DOCKER_REGISTRY }}
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
          DOCKER_IMAGE_NAME: ${{ env.DOCKER_IMAGE_NAME }}
          DEPLOY_PATH: ${{ env.DEPLOY_PATH }}
        with:
          host: ${{ secrets.ALIYUN_SERVER_HOST }}
          port: ${{ secrets.ALIYUN_SERVER_PORT }}
          username: ${{ secrets.ALIYUN_SERVER_USER }}
          key: ${{ secrets.ALIYUN_SERVER_SSH_KEY }}
          envs: ROLLBACK_TAG,DOCKER_REGISTRY,DOCKER_USERNAME,DOCKER_PASSWORD,DOCKER_IMAGE_NAME,DEPLOY_PATH
          script: |
            cd ${DEPLOY_PATH}

            echo "=========================================="
            echo "å¼€å§‹å›æ»š Bondee åº”ç”¨"
            echo "æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
            echo "=========================================="

            # ç™»å½• Docker Registryï¼ˆå¦‚æœéœ€è¦ï¼‰
            echo "${DOCKER_PASSWORD}" | docker login ${DOCKER_REGISTRY} -u "${DOCKER_USERNAME}" --password-stdin

            # 1. æŸ¥çœ‹å¯ç”¨çš„é•œåƒç‰ˆæœ¬
            echo ""
            echo "ğŸ“‹ å¯ç”¨çš„é•œåƒç‰ˆæœ¬ï¼š"
            docker images ${DOCKER_REGISTRY}/${DOCKER_IMAGE_NAME} --format "table {{.Tag}}\t{{.CreatedAt}}\t{{.Size}}" | head -10

            # 2. è®¾ç½®å›æ»šç‰ˆæœ¬
            echo ""
            echo "ğŸ”„ å›æ»šåˆ°ç‰ˆæœ¬: ${ROLLBACK_TAG}"

            # 3. æ£€æŸ¥ç›®æ ‡é•œåƒæ˜¯å¦å­˜åœ¨
            if ! docker images ${DOCKER_REGISTRY}/${DOCKER_IMAGE_NAME}:${ROLLBACK_TAG} -q | grep -q .; then
              echo "âŒ é”™è¯¯: é•œåƒç‰ˆæœ¬ ${ROLLBACK_TAG} ä¸å­˜åœ¨"
              echo "å¯ç”¨ç‰ˆæœ¬ï¼š"
              docker images ${DOCKER_REGISTRY}/${DOCKER_IMAGE_NAME} --format "{{.Tag}}"
              exit 1
            fi

            # 4. è®¾ç½®é•œåƒç‰ˆæœ¬
            export DOCKER_IMAGE="${DOCKER_REGISTRY}/${DOCKER_IMAGE_NAME}:${ROLLBACK_TAG}"

            # 5. åœæ­¢å½“å‰å®¹å™¨
            echo ""
            echo "ğŸ›‘ åœæ­¢å½“å‰å®¹å™¨..."
            docker compose down --timeout 30

            # 6. æ›´æ–° docker-compose ä½¿ç”¨æŒ‡å®šç‰ˆæœ¬
            # ä¸´æ—¶è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œè®© docker-compose ä½¿ç”¨æŒ‡å®šç‰ˆæœ¬
            echo "DOCKER_IMAGE=${DOCKER_IMAGE}" > .env.rollback

            # 7. å¯åŠ¨æŒ‡å®šç‰ˆæœ¬
            echo ""
            echo "ğŸš€ å¯åŠ¨ç‰ˆæœ¬ ${ROLLBACK_TAG}..."
            docker compose --env-file .env.rollback up -d

            # 8. ç­‰å¾…æœåŠ¡å°±ç»ª
            echo ""
            echo "â³ ç­‰å¾…æœåŠ¡å°±ç»ª..."
            sleep 10

            # 9. å¥åº·æ£€æŸ¥
            echo ""
            echo "ğŸ” æ‰§è¡Œå¥åº·æ£€æŸ¥..."
            MAX_RETRIES=10
            RETRY_COUNT=0

            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
                if curl -f http://localhost/health > /dev/null 2>&1; then
                    echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡ï¼"
                    break
                else
                    RETRY_COUNT=$((RETRY_COUNT + 1))
                    echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨... ($RETRY_COUNT/$MAX_RETRIES)"
                    sleep 3
                fi
                
                if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
                    echo "âŒ å›æ»šåå¥åº·æ£€æŸ¥å¤±è´¥"
                    echo "æŸ¥çœ‹æ—¥å¿—ï¼š"
                    docker compose logs --tail=50
                    exit 1
                fi
            done

            # 10. æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            rm -f .env.rollback

            # 11. æ˜¾ç¤ºè¿è¡ŒçŠ¶æ€
            echo ""
            echo "=========================================="
            echo "ğŸ“Š å›æ»šåçŠ¶æ€"
            echo "=========================================="
            docker compose ps

            echo ""
            echo "=========================================="
            echo "ğŸ‰ å›æ»šå®Œæˆï¼"
            echo "å½“å‰ç‰ˆæœ¬: ${ROLLBACK_TAG}"
            echo "æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
            echo "=========================================="

      - name: Verify rollback
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.ALIYUN_SERVER_HOST }}
          port: ${{ secrets.ALIYUN_SERVER_PORT }}
          username: ${{ secrets.ALIYUN_SERVER_USER }}
          key: ${{ secrets.ALIYUN_SERVER_SSH_KEY }}
          script: |
            cd ${{ env.DEPLOY_PATH }}

            # æœ€ç»ˆéªŒè¯
            if curl -f http://localhost/health > /dev/null 2>&1; then
              echo "âœ… å›æ»šéªŒè¯æˆåŠŸï¼"
              echo "å½“å‰è¿è¡Œçš„å®¹å™¨ï¼š"
              docker compose ps
            else
              echo "âŒ å›æ»šéªŒè¯å¤±è´¥"
              exit 1
            fi

      - name: Notify rollback status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "ğŸ‰ å›æ»šæˆåŠŸï¼"
            echo "å·²å›æ»šåˆ°ç‰ˆæœ¬: ${{ inputs.version }}"
          else
            echo "âŒ å›æ»šå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
          fi
