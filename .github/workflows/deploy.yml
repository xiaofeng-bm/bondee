name: Deploy to Aliyun

# è§¦å‘æ¡ä»¶
on:
  push:
    branches:
      - main # å½“æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘
  workflow_dispatch: # å…è®¸åœ¨ GitHub Actions é¡µé¢æ‰‹åŠ¨è§¦å‘

# ä»»åŠ¡å®šä¹‰
jobs:
  deploy:
    name: ğŸš€ éƒ¨ç½²åˆ°é˜¿é‡Œäº‘æœåŠ¡å™¨
    runs-on: ubuntu-latest # åœ¨ GitHub æä¾›çš„ Ubuntu è™šæ‹Ÿæœºä¸Šè¿è¡Œ

    steps:
      # ==================== æ­¥éª¤ 1: æ£€å‡ºä»£ç  ====================
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ==================== æ­¥éª¤ 2: è®¾ç½® Node.js ç¯å¢ƒ ====================
      - name: ğŸŸ¢ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # ==================== æ­¥éª¤ 3: å®‰è£… pnpm ====================
      - name: ğŸ“¦ å®‰è£… pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10

      # ==================== æ­¥éª¤ 4: å®‰è£…ä¾èµ– ====================
      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      # ==================== æ­¥éª¤ 5: ä»£ç è´¨é‡æ£€æŸ¥ ====================
      - name: ğŸ” ä»£ç è´¨é‡æ£€æŸ¥
        run: pnpm run lint
        continue-on-error: false

      # ==================== æ­¥éª¤ 6: æ„å»ºé¡¹ç›® ====================
      - name: ğŸ”¨ æ„å»ºé¡¹ç›®
        run: pnpm run build
        env:
          NODE_ENV: production

      # ==================== æ­¥éª¤ 7: å¤‡ä»½æ—§æ–‡ä»¶ (å¯é€‰) ====================
      - name: ğŸ“¦ å¤‡ä»½æœåŠ¡å™¨æ—§æ–‡ä»¶
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          script: |
            # å¦‚æœå­˜åœ¨æ—§çš„ distï¼Œå°†å…¶é‡å‘½åå¤‡ä»½ï¼ˆåªä¿ç•™ä¸€ä¸ªæœ€è¿‘çš„å¤‡ä»½å³å¯ï¼Œæˆ–è€…æŒ‰æ—¶é—´æˆ³ï¼‰
            if [ -d "/var/www/bondee/dist" ]; then
              rm -rf /var/www/bondee/dist_backup
              mv /var/www/bondee/dist /var/www/bondee/dist_backup
              echo "âœ… æ—§ç‰ˆæœ¬å·²å¤‡ä»½ä¸º dist_backup"
            fi
            # ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨
            mkdir -p /var/www/bondee

      # ==================== æ­¥éª¤ 8: ä¸Šä¼ æ„å»ºäº§ç‰© ====================
      # æ ¸å¿ƒæ­¥éª¤ï¼šæŠŠ GitHub æ„å»ºå¥½çš„ dist ä¼ ç»™æœåŠ¡å™¨
      - name: ï¿½ ä¸Šä¼  dist åˆ°æœåŠ¡å™¨
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          source: "dist"
          target: "/var/www/bondee"
          strip_components: 0 # ä¿æŒç›®å½•ç»“æ„ï¼Œå³ä¸Šä¼ åä¸º /var/www/bondee/dist

      # ==================== æ­¥éª¤ 9: é‡å¯ Nginx ====================
      - name: ğŸ”„ é‡å¯ Nginx
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          script: |
            # ç¡®ä¿æƒé™æ­£ç¡® (Nginx é€šå¸¸è¿è¡Œåœ¨ www-data ç”¨æˆ·ä¸‹ï¼Œæˆ–è€…ä¿æŒå½“å‰ç”¨æˆ·å¯è¯»)
            chmod -R 755 /var/www/bondee/dist
            
            # é‡è½½ Nginx é…ç½®
            sudo systemctl reload nginx
            echo "âœ… Nginx é‡è½½å®Œæˆ"

      # ==================== æ­¥éª¤ 10: éƒ¨ç½²ç»“æœé€šçŸ¥ ====================
      - name: ğŸ“¢ éƒ¨ç½²ç»“æœé€šçŸ¥
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
            echo "ğŸŒ è®¿é—®åœ°å€: http://${{ secrets.SERVER_HOST }}"
          else
            echo "âŒ éƒ¨ç½²å¤±è´¥ï¼è¯·æ£€æŸ¥æ—¥å¿—"
          fi
